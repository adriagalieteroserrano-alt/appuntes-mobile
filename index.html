<!doctype html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Appuntes V23 (VersiÃ³n Final Corregida)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#3b82f6">
  <link rel="stylesheet" href="styles.css">
</head>
<body>


  <button id="themeToggle" title="Cambiar Tema">ğŸŒ“</button>

  <div id="welcome" class="screen active">
    <div class="title-wrap">
      <h1><span class="logo-app">App</span><span class="logo-untes">untes</span></h1>
      <p>Tu biblioteca digital de apuntes con enfoque curricular.</p>
      <button id="startBtn" class="btn">Comenzar</button>
    </div>
  </div>

  <div id="auth" class="screen">
    <div class="panel">
      
      <div id="authErrorMessage" style="position: absolute; top: 0; left: 0; right: 0; z-index: 10; color: #991b1b; padding: 15px; margin: 20px; border: 1px solid #fca5a5; background: #fee2e2; border-radius: 6px; display: none; font-weight: bold; text-align: center;"></div>
      
      <div id="registroFormWrap" class="form-wrap">
        <h2>Crear cuenta</h2>
        <form id="registroForm" novalidate>
          <label>Elige tu Avatar</label>
          <div id="avatarSelectionContainer" class="avatar-grid">
              </div>
          <input type="hidden" id="selectedAvatar" value="" />

          <label for="rol">Rol</label>
          <select id="rol" required>
            <option value="Alumno">Alumno/a</option>
            <option value="Profesor">Profesor/a</option>
          </select>

          <label for="alias">Alias (nombre de usuario)</label>
          <input type="text" id="alias" required />

          <label for="password">ContraseÃ±a</label>
          <input type="password" id="password" required />

          <label for="comunidad">Comunidad AutÃ³noma</label>
          <select id="comunidad" required>
            <option value="" disabled selected>Selecciona tu comunidad</option>
            <option>AndalucÃ­a</option>
            <option>AragÃ³n</option>
            <option>Principado de Asturias</option>
            <option>Islas Baleares</option>
            <option>Canarias</option>
            <option>Cantabria</option>
            <option>Castilla-La Mancha</option>
            <option>Castilla y LeÃ³n</option>
            <option>CataluÃ±a</option>
            <option>Comunidad de Madrid</option>
            <option>Comunidad Foral de Navarra</option>
            <option>Comunidad Valenciana</option>
            <option>Extremadura</option>
            <option>Galicia</option>
            <option>RegiÃ³n de Murcia</option>
            <option>PaÃ­s Vasco</option>
            <option>La Rioja</option>
            <option>Ciudad AutÃ³noma de Ceuta</option>
            <option>Ciudad AutÃ³noma de Melilla</option>
          </select>
          <div id="alumnoFields">
            <label for="curso">Curso</label>
            <select id="curso" required>
              <option value="" disabled selected>Selecciona tu curso</option> 
              <optgroup label="ESO">
                <option value="1Âº ESO">1Âº ESO</option>
                <option value="2Âº ESO">2Âº ESO</option>
                <option value="3Âº ESO">3Âº ESO</option>
                <option value="4Âº ESO">4Âº ESO</option>
              </optgroup>
              <optgroup label="Bachillerato Ciencias/TecnologÃ­a">
                <option value="1Âº Bachillerato Ciencias y TecnologÃ­a">1Âº Bachillerato Ciencias y TecnologÃ­a</option>
                <option value="2Âº Bachillerato Ciencias y TecnologÃ­a">2Âº Bachillerato Ciencias y TecnologÃ­a</option>
              </optgroup>
              <optgroup label="Bachillerato Humanidades/CCSS">
                <option value="1Âº Bachillerato Humanidades y Ciencias Sociales">1Âº Bachillerato Humanidades y Ciencias Sociales</option>
                <option value="2Âº Bachillerato Humanidades y Ciencias Sociales">2Âº Bachillerato Humanidades y Ciencias Sociales</option>
              </optgroup>
              <optgroup label="Bachillerato Artes (PlÃ¡sticas/DiseÃ±o)">
                <option value="1Âº Bachillerato Artes">1Âº Bachillerato Artes</option>
                <option value="2Âº Bachillerato Artes">2Âº Bachillerato Artes</option>
              </optgroup>
              <optgroup label="Bachillerato General">
                <option value="1Âº Bachillerato General">1Âº Bachillerato General</option>
                <option value="2Âº Bachillerato General">2Âº Bachillerato General</option>
              </optgroup>
              <optgroup label="IB">
                <option value="IB Year 1">IB Year 1</option>
                <option value="IB Year 2">IB Year 2</option>
              </optgroup>
            </select>
            
            <label for="colegio">Colegio</label>
            <input type="text" id="colegio" required />
            
            </div>

          <div id="profesorFields" class="hidden">
            <label>Niveles que imparte</label>
            <div style="margin-bottom: 15px;">
              <label style="display:inline-flex; align-items:center; gap:5px; font-weight: normal;">
                <input type="checkbox" id="nivelESO" name="nivelesImparte" value="ESO" /> ESO
              </label>
              <label style="display:inline-flex; align-items:center; gap:5px; font-weight: normal;">
                <input type="checkbox" id="nivelBachiller" name="nivelesImparte" value="Bachiller" /> Bachillerato
              </label>
              <label style="display:inline-flex; align-items:center; gap:5px; font-weight: normal;">
                <input type="checkbox" id="nivelIB" name="nivelesImparte" value="IB" /> Bachillerato Internacional (IB)
              </label>
            </div>

            <label for="nombreReal">Nombre y Apellidos Reales (Opcional en registro)</label>
            <input type="text" id="nombreReal" />

            <label for="colegioProfe">Colegio en el que imparte (Opcional en registro)</label>
            <input type="text" id="colegioProfe" />

            <label for="docProfe">DocumentaciÃ³n Acreditativa (PDF/IMG - Opcional en registro)</label>
            <input type="file" id="docProfe" accept=".pdf, .jpg, .jpeg, .png" />
            
            <p style="font-size: 0.85rem; color: var(--muted); margin-top: 5px; margin-bottom: 15px; background: var(--bg-screen); padding: 5px; border-radius: 4px; border: 1px dashed var(--border);">
               ğŸ”’ <strong>Privacidad:</strong> Su nombre real, colegio donde imparte y el archivo adjunto <strong>NO serÃ¡n pÃºblicos</strong> y nadie de la aplicaciÃ³n tendrÃ¡ acceso a ellos.
            </p>

            <div style="background: #fff7ed; border: 1px solid #ffedd5; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.85rem; color: #c2410c;">
                <strong>Aviso importante:</strong> Mientras estos datos y documentaciÃ³n no sean revisados, su cuenta permanecerÃ¡ en estado <strong>INACTIVO</strong>. Puede registrarlos ahora o mÃ¡s tarde desde su perfil.
            </div>
          </div>

          <button type="submit" class="btn" style="width:100%;margin-top:15px;">Crear Cuenta</button>
        </form>
        <div style="text-align: right; margin-top: 10px;">
            <span id="adminTrigger">administrador</span>
        </div>
      </div>

      <div id="loginFormWrap" class="form-wrap" style="background:var(--bg-screen)">
        <h2>Iniciar sesiÃ³n</h2>
        <form id="loginForm" novalidate>
          <label for="loginAlias">Alias</label>
          <input type="text" id="loginAlias" required />
          
          <label for="loginPassword">ContraseÃ±a</label>
          <input type="password" id="loginPassword" required />
          
          <button type="submit" class="btn secondary" style="width:100%;margin-top:15px;">Entrar</button>
        </form>
      </div>
    </div>
  </div>
<div id="dashboard" class="screen">
      <div class="container">
          <div class="dash-card dash-welcome">
              <div id="dashAvatar" class="dash-avatar"></div>
              <h2>Â¡Hola, <span id="dashName"></span>! ğŸ‘‹</h2>
              <p>Â¿QuÃ© vamos a aprender hoy?</p>
              <div class="group">
                <button id="dashBtnSubjects" class="btn">ğŸ“š Mis Asignaturas</button>
                <button id="dashBtnProfile" class="btn secondary">ğŸ‘¤ Mi Perfil</button>
              </div>
          </div>
          <div class="dash-card">
              <h3>Tu Actividad</h3>
              <p>Apuntes Creados: <span id="dashCreated" class="stat-number">0</span></p>
              <p>Apuntes Consultados: <span id="dashConsulted" class="stat-number">0</span></p>
          </div>
          <div class="dash-card">
              <h3>Acciones RÃ¡pidas</h3>
               <button id="dashBtnSearch" class="btn secondary" style="width:100%; margin-bottom:5px;">ğŸ” BÃºsqueda RÃ¡pida</button>
               <button id="dashBtnRequest" class="btn secondary" style="width:100%;">ğŸ“ Peticiones</button>
          </div>
          <div class="motivation-quote">
              "<span id="dashQuote"></span>"
          </div>
      </div>
  </div>
  
  <div id="subjects" class="screen">
    <div class="container">
      <div class="box" style="grid-column: 1 / span 2;">
        <h2 id="subjectsTitle">Asignaturas</h2>
        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="btnBackToDash" class="btn secondary">ğŸ  Volver al Inicio</button>
            <button id="btnStructuredSearch" class="btn" style="flex: 1; min-width: 150px;">ğŸ” BÃºsqueda Estructurada</button>
            <button id="btnRequestNote" class="btn secondary" style="background: var(--accent); min-width: 150px;">ğŸ“ Solicitud de Apunte</button> 
        </div>
        </div>

      <div class="box list">
        <h3>Cursos y Asignaturas</h3>
        <div id="subjectsContainer">
          </div>
      </div>

      <div class="box">
        <div id="topicsContainer">
          </div>
        <div id="optionsContainer">
          </div>
        <div id="notesContainer">
          </div>
      </div>
    </div>
  </div>

  <div id="profile" class="screen">
    <div class="title-wrap" style="max-width: 600px; text-align: left;">
      <h2>Mi Perfil</h2>
      <div id="profileAvatarDisplay" class="profile-avatar-large">ğŸ‘¤</div>
      
      <p>Alias: <strong id="profileAlias"></strong></p>
      <p>Rol: <strong id="profileRol"></strong></p>
      <p>Comunidad AutÃ³noma: <strong id="profileComunidad"></strong></p> 
      <div id="profileUserDetails"></div>
      
      <div id="profileAccountStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold;">
      </div>
      
      <div id="teacherMissingDataContainer" class="hidden" style="margin-top: 20px; border: 1px solid var(--warning); background: #fff7ed; padding: 15px; border-radius: 8px;">
          <h3 style="color: #c2410c; margin-top: 0;">âš ï¸ Completar Registro de Profesor</h3>
          <p style="font-size: 0.9rem;">Para activar tu cuenta y poder subir apuntes o gestionar solicitudes, debes completar los siguientes datos:</p>
          <form id="teacherUpdateForm">
              <label for="updateRealName">Nombre Real</label>
              <input type="text" id="updateRealName" required />
              
              <label for="updateSchool">Colegio</label>
              <input type="text" id="updateSchool" required />
              
              <label for="updateDoc">DocumentaciÃ³n</label>
              <input type="file" id="updateDoc" accept=".pdf, .jpg, .jpeg, .png" required />
              
              <button type="submit" class="btn warning" style="width:100%;">Guardar y Solicitar RevisiÃ³n</button>
          </form>
      </div>

      <hr style="border: 0; border-top: 1px solid var(--border); margin: 15px 0;">
      <h3>EstadÃ­sticas:</h3>
      <p>Visitas a la aplicaciÃ³n: <strong id="profileVisits"></strong></p>
      <p>Apuntes creados: <strong id="profileCreated"></strong></p>
      <p>Apuntes consultados: <strong id="profileConsulted"></strong></p>
      
      <div id="userFavoritesContainer" style="margin-top: 20px; max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background-color: var(--bg-screen);">
          <h3 style="color: var(--danger);">â­ Mis Favoritos</h3>
          <div id="favoritesListContent"></div>
      </div>

      <div class="group" style="margin-top: 20px;">
        <button id="backToDashFromProfile" class="btn">ğŸ  Dashboard</button>
        <button id="backToAuth" class="btn secondary">Cerrar SesiÃ³n</button>
        <button id="exitApp" class="btn secondary" style="background: #ef4444;">Salir de Appuntes</button>
      </div>
    </div>
  </div>

  <div id="protectedModal" class="screen">
    <div class="modal-content">
      <h2 id="modalTitle"></h2>
      <div id="modalContent">
        </div>
      <p class="muted" style="text-align: center; margin-top: 20px;">Pulsa cualquier tecla para cerrar la vista protegida.</p>
    </div>
  </div>
  
  <div id="structuredSearchModal" class="screen">
    <div class="modal-content" style="max-width: 600px;">
        <h2 id="structuredSearchTitle">BÃºsqueda Estructurada</h2>
        <div id="searchFlowContainer" class="form-wrap" style="padding: 10px;">
            </div>
        <div style="text-align: right; margin-top: 20px;" class="group">
            <button id="searchGoBackBtn" class="btn secondary hidden" style="margin-right: auto;">â—€ï¸ AtrÃ¡s</button>
            <button id="closeSearchModal" class="btn secondary">Cerrar</button>
        </div>
    </div>
  </div>
  
  <div id="requestNoteModal" class="screen">
    <div class="modal-content" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column;">
        <h2 id="requestNoteTitle">Mis Solicitudes</h2>
        
        <div id="studentRequestsList" style="flex: 1; overflow-y: auto; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; padding: 10px; background: var(--bg-screen);">
        </div>
        
        <div id="requestFlowContainer" class="form-wrap hidden" style="padding: 10px; border: 1px dashed var(--brand); border-radius: 6px; background: var(--bg-panel);">
        </div>

        <div style="text-align: right; margin-top: 10px;" class="group">
            <button id="requestGoBackBtn" class="btn secondary hidden" style="margin-right: auto;">â—€ï¸ AtrÃ¡s</button>
            <button id="newRequestBtn" class="btn" style="margin-right: auto;">+ Nueva Solicitud</button>
            <button id="closeRequestModal" class="btn secondary">Cerrar</button>
            <button id="submitRequestBtn" class="btn" style="display:none;">Enviar Solicitud</button>
        </div>
    </div>
  </div>

  <div id="requestsModal" class="screen">
    <div class="modal-content" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">
        <h2 id="requestsTitle">GestiÃ³n de Solicitudes (Profesor)</h2>
        <div id="requestsContainer" class="form-wrap" style="flex: 1; overflow-y: auto; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; background: var(--bg-screen);">
        </div>
        <div style="text-align: right; margin-top: 10px;">
            <button id="closeRequestsModal" class="btn secondary">Cerrar</button>
        </div>
    </div>
  </div>

  <div id="requestEditorModal" class="screen">
    <div class="modal-content" style="max-width: 800px;">
        <h2>Responder a Solicitud</h2>
        <div style="background: var(--bg-screen); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
            <p style="margin:0;"><strong>Solicitante:</strong> <span id="editorRequester"></span></p>
            <p style="margin:0;"><strong>Asignatura:</strong> <span id="editorContext"></span></p>
            <p style="margin-top:5px; font-style: italic;">"<span id="editorOriginalRequest"></span>"</p>
        </div>

        <form id="editorForm">
            <label for="editorTitle">TÃ­tulo del Apunte</label>
            <input type="text" id="editorTitle" placeholder="Ej: Resumen de la CÃ©lula" required />
            
            <label for="editorText">Contenido de Texto</label>
            <textarea id="editorText" placeholder="Escribe aquÃ­ el contenido del apunte..."></textarea>
            
            <label>Archivo Adjunto Actual: <span id="editorCurrentFile" style="font-weight: normal; color: var(--muted);">Ninguno</span></label>
            <label for="editorFile" class="btn secondary" style="display:inline-block; margin-top:0;">Subir/Cambiar Archivo (PDF/IMG)</label>
            <input type="file" id="editorFile" accept=".pdf, .jpg, .jpeg, .png" class="hidden" />

            <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border: 1px dashed var(--brand); border-radius: 6px;">
                <label style="color:var(--brand); font-weight:bold; display:block; margin-bottom:5px;">ğŸ“¸ O escanear con la cÃ¡mara:</label>
                <input type="file" id="editorCamera" accept="image/*" capture="environment" class="btn" style="width:100%; background:var(--ink); color:white;">
                
                <img id="editorCameraPreview" style="width:100%; margin-top:10px; display:none; border-radius:6px; border:2px solid var(--brand);">
                <input type="hidden" id="editorCameraBase64">
            </div>

            <button type="button" id="editorClearFileBtn" class="btn danger hidden" style="font-size: 0.8rem; padding: 5px 10px;">Quitar Archivo</button>
        </form>

        <div class="group" style="margin-top: 25px; border-top: 1px solid var(--border); padding-top: 15px; justify-content: flex-end;">
            <button id="editorCancelBtn" class="btn secondary">Cancelar</button>
            <button id="editorSaveDraftBtn" class="btn warning">ğŸ’¾ Guardar como Borrador</button>
            <button id="editorPublishBtn" class="btn success">âœ… Publicar y Completar</button>
        </div>
    </div>
  </div>

  <div id="adminAuthModal" class="screen">
      <div class="modal-content" style="max-width: 400px; text-align: center;">
          <h2>Acceso Administrador</h2>
          <form id="adminAuthForm">
            <input type="text" id="adminUser" placeholder="Usuario" style="margin-bottom: 10px;" required />
            <input type="password" id="adminPass" placeholder="ContraseÃ±a" style="margin-bottom: 10px;" required />
            <button type="submit" class="btn" style="width: 100%;">Entrar</button>
          </form>
          <button id="closeAdminAuth" class="btn secondary" style="width: 100%; margin-top: 10px;">Cancelar</button>
      </div>
  </div>

  <div id="adminPanelScreen" class="screen">
      <div class="modal-content" style="max-width: 1100px; height: 90vh; display: flex; flex-direction: column;">
          <h2>Panel de AdministraciÃ³n de Usuarios</h2>
          <div style="flex: 1; overflow-y: auto;">
              <table id="adminTable">
                  <thead>
                      <tr>
                          <th>Fecha Registro</th>
                          <th>Avatar</th>
                          <th>Alias</th>
                          <th>Rol</th>
                          <th>Comunidad</th>
                          <th>Colegio / Nombre Real</th>
                          <th>Estado</th>
                          <th>Acciones</th>
                      </tr>
                  </thead>
                  <tbody id="adminTableBody">
                      </tbody>
              </table>
          </div>
          <div style="text-align: right; margin-top: 20px;">
              <button id="closeAdminPanel" class="btn secondary">Cerrar SesiÃ³n Admin</button>
          </div>
      </div>
  </div>
  
  <div id="teacherCourseModal" class="screen">
      <div class="modal-content" style="max-width: 500px; text-align: center;">
          <h2>Selecciona Curso</h2>
          <div id="teacherCourseContainer" class="group" style="justify-content: center;">
          </div>
          <button id="closeTeacherCourseModal" class="btn secondary" style="margin-top: 20px;">Cancelar</button>
      </div>
  </div>
  
  <div id="flashcardsModal" class="screen">
    <div class="modal-content">
        <h2 id="flashcardModalTitle">ğŸƒ Flashcards</h2>
        <div style="margin-bottom: 20px; padding: 10px; background: var(--bg-body); border: 1px dashed var(--border); border-radius: 6px; font-size: 0.9rem; color: var(--muted);">
            **Nota:** Las Flashcards son apuntes de estudio personales (Pregunta/Respuesta) que creas tÃº mismo a partir del apunte. Solo tÃº puedes verlas y editarlas.
        </div>
        <div id="flashcardContent">
            </div>
        <div style="text-align: right; margin-top: 20px;">
            <button id="closeFlashcardsModal" class="btn secondary">Volver al Apunte</button>
        </div>
    </div>
  </div>
<div id="achievementModal" class="screen" style="background: rgba(0,0,0,0.85); z-index: 2000;">
    <div class="modal-content" style="text-align: center; max-width: 500px; border: 2px solid gold; box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);">
        <div style="font-size: 5rem; animation: bounce 1s infinite;">ğŸ†</div>
        <h2 style="color: gold; text-transform: uppercase; letter-spacing: 2px; margin-top: 10px;">Â¡Logro Desbloqueado!</h2>
        <h3 id="badgeTitle" style="color: var(--ink); margin: 10px 0;">TÃ­tulo del Logro</h3>
        <p id="badgeDesc" style="color: var(--muted); font-style: italic;">DescripciÃ³n del logro...</p>
        <div style="margin-top: 30px;">
            <button class="btn" style="background: gold; color: black; font-weight: bold; width: 100%;" onclick="closeAchievementModal()">Â¡Genial!</button>
        </div>
    </div>
</div>
<div id="toast-container"></div>
<script src="data.js"></script>
<script src="notifications.js"></script> 
<script src="script.js"></script>        
</body>
</html>
